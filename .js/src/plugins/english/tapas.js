var t=this&&this.__awaiter||function(t,e,r,n){return new(r||(r=Promise))((function(i,a){function o(t){try{l(n.next(t))}catch(t){a(t)}}function s(t){try{l(n.throw(t))}catch(t){a(t)}}function l(t){var e;t.done?i(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(o,s)}l((n=n.apply(t,e||[])).next())}))},e=this&&this.__generator||function(t,e){var r,n,i,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=s(0),o.throw=s(1),o.return=s(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(s){return function(l){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,s[0]&&(a=0)),a;)try{if(r=1,n&&(i=2&s[0]?n.return:s[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,s[1])).done)return i;switch(n=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,n=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(i=a.trys,(i=i.length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){a.label=s[1];break}if(6===s[0]&&a.label<i[1]){a.label=i[1],i=s;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(s);break}i[2]&&a.ops.pop(),a.trys.pop();continue}s=e.call(t,a)}catch(t){s=[6,t],n=0}finally{r=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,l])}}};Object.defineProperty(exports,"__esModule",{value:!0});var r=require("@libs/fetch"),n=require("@libs/filterInputs"),i=require("cheerio"),a=require("@libs/novelStatus"),o=require("@libs/storage"),s=function(){function s(){this.id="tapas",this.name="Tapas",this.icon="/src/en/tapas/icon.png",this.site="https://tapas.io/",this.version="1.0.0",this.extra=o.storage.get("url"),this.switch=""!==o.storage.get("switch"),this.filters={order:{label:"Order",options:[{label:"Popular",value:""},{label:"Newest",value:"newest"}],type:n.FilterTypes.Picker,value:""},status:{label:"Status",options:[{label:"All",value:""},{label:"Ongoing",value:"ongoing"},{label:"Hiatus",value:"hiatus"},{label:"Completed",value:"completed"}],type:n.FilterTypes.Picker,value:""}},this.pluginSettings={url:{value:"",label:"URL"},switch:{value:"",label:"switch"}}}return s.prototype.popularNovels=function(r,n){return t(this,arguments,void 0,(function(t,r){r.showLatestNovels,r.filters;return e(this,(function(t){return[2,[]]}))}))},s.prototype.parseNovel=function(n){return t(this,void 0,void 0,(function(){var t,o,s,l,c,u,p,h,f,d,v,m,b,g;return e(this,(function(e){switch(e.label){case 0:return[4,(0,r.fetchApi)("".concat(this.site).concat(n)).then((function(t){return t.text()}))];case 1:t=e.sent(),o=(0,i.load)(t),s={path:n,name:o("div.title-wrapper a.title").text(),author:o("ul.creator-section a.name").text(),cover:o("div.thumb-wrapper img").attr("src"),genres:o("div.info-detail a.genre-btn").text(),status:"Completed series"===o("div.schedule span.schedule-label:first").text()?a.NovelStatus.Completed:a.NovelStatus.Ongoing,summary:o("div.row-body span.description__body").text()},l=[],c=null===(g=o("meta[property='al:android:url']").attr("content"))||void 0===g?void 0:g.split("/",4).pop(),u=20,p=!0,h="undefined",f=1,e.label=2;case 2:return!0!==p?[3,5]:(d="".concat(this.site,"series/").concat(c,"/episodes?page=").concat(f,"&sort=OLDEST&max_limit=").concat(u),[4,fetch(d).then((function(t){return t.json()}))]);case 3:v=e.sent().data,m=v.episodes,"undefined"===h&&(h=m.filter((function(t){return t.title.includes("Chapter")})).length>3?"false":"true"),m.map((function(t){var e={name:("true"===h?"".concat(t.scene," | "):"")+t.title,path:"episode/".concat(t.id),releaseTime:t.publish_date,chapterNumber:t.scene};0!=t.scene&&l.push(e)})),p=v.pagination.has_next&&m.length==u,e.label=4;case 4:return f++,[3,2];case 5:return b={id:c,title:s.name,chapters:l.length,cover:s.cover,list:JSON.stringify(l)},(0,r.fetchApi)("".concat(this.extra,"series/add"),{method:"POST",body:JSON.stringify(b)}),s.chapters=l,[2,s]}}))}))},s.prototype.parseChapter=function(n){return t(this,void 0,void 0,(function(){var t,a,o,s,l,c,u,p,h,f,d,v;return e(this,(function(e){switch(e.label){case 0:return t=this.switch?this.extra:this.site,[4,(0,r.fetchApi)("".concat(t).concat(n)).then((function(t){return t.text()}))];case 1:return a=e.sent(),o=(0,i.load)(a),s=o("div.viewer__header .title").text(),(l=o("article")).length?(this.switch||(c=null===(v=o("meta[property='al:android:url']").attr("content"))||void 0===v?void 0:v.split("/",4).pop(),u=n.split("/")[1],p={series_id:c,id:u,title:s,content:l.html()},(0,r.fetchApi)("".concat(this.extra,"chapters/add"),{method:"POST",body:JSON.stringify(p)})),o("article [sdttag]").map((function(t,e){var r=o(e);0!==r.length&&r.replaceWith(r.contents())})),o("article span").map((function(t,e){var r=o(e),n=r.contents(),i=r.prop("style");if(i){var a="italic"===i["font-style"],s=["700","bold","bolder"].includes(String(i["font-weight"]));a&&r.wrap("<i></i>"),s&&r.wrap("<b></b>")}0===n.length?r.remove():r.replaceWith(n)})),o("article br").map((function(t,e){var r=o(e),n=r.parent().prop("tagName"),i=r.next().prop("tagName");"DIV"===n&&"BR"!==i&&r.remove()})),h=0,o("article p").map((function(t,e){var r=o(e),n=r.prop("style");if(n){var i=String(n["text-align"]);e.attribs="text-align"in n&&["left","center"].includes(i)?{style:"text-align:".concat(i)}:{}}var a=r.find("img"),s=r.text().trim();""!==s||a.length?"***"!==s&&"* * *"!==s||r.addClass("special"):(r.addClass("empty"),h++)})),o("article .empty").map((function(t,e){var r="empty"===o(e).next().prop("class");h<30||r?o(e).replaceWith("<br>"):o(e).remove()})),"BR"!==(f=o("article .special")).prev().prop("tagName")&&f.before("<br>"),"BR"!==f.next().prop("tagName")&&f.after("<br>"),f.removeClass("special"),o('div[id="viewport"] [id]').map((function(t,e){var r=o(e),n=r.contents();0===n.length?r.remove():r.replaceWith(n)})),o('div[id="viewport"]').children().map((function(t,e){if("Localization Credits"===o(e).text()){o(e).nextAll().remove();for(var r=!0;r;){var n=o(e).prev();""===o(n).text().trim()?o(n).remove():r=!1}o(e).remove()}})),(d=(d=o("article").html()||"").split("\n").filter((function(t){return t.trim()})).join("\n")).length&&(d='<h2 style="text-align: center;">'.concat(s,"</h2><p>â€‹</p>\n").concat(d)),d.length<1e3&&(d=""),[2,d]):[2,""]}}))}))},s.prototype.searchNovels=function(n,a){return t(this,void 0,void 0,(function(){var t,a,o,s;return e(this,(function(e){switch(e.label){case 0:return t=[],a="".concat(this.site,"search?q=").concat(n,"&t=NOVELS"),[4,(0,r.fetchApi)(a)];case 1:return[4,e.sent().text()];case 2:return o=e.sent(),(s=(0,i.load)(o))("ul.section-list li").map((function(e,r){var n=s(r).attr("data-href");if(!n)return null;t.push({name:s(r).find(".desc-wrap .title").text(),path:n.replace("/series","series")+"/info",cover:s(r).find(".thumb-wrap img").attr("src")})})),[2,t]}}))}))},s}();exports.default=new s;